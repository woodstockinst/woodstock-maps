window.app={addDataValue:function(a){_.each(a,function(a){$(a).attr("data-value",$(a).html().replace(".","").split(" ").join("_").toLowerCase())})},init:function(a){"use strict";app.config=new app.ConfigCollection,app.config.init(a),app.router=new app.Router,Backbone.history.start()},template:function(a,b,c,d){var c=c||{};document.getElementById(a+"-template")?d&&_.isFunction(d)&&d():$.get(b,function(b){$("#templates").append('<div id="'+a+'-template">'+_(b).template(c)+"</div>"),d&&_.isFunction(d)&&d()})},human_metrics:{pct_vacant:"percent vacancy",pct_change:"change in percent vacancy",pct_owner_occupied:"percent for owner-occupied",pct_originated:"percent originated",pct_conventional:"percent conventional loans",avg_amount:"average mortgage amount"}},$(document).ready(function(){"use strict";queue().defer(d3.json,"data/config.json",app.init)}),this.JST=this.JST||{},app.Routers=app.Routers||{},function(){"use strict";app.Router=Backbone.Router.extend({routes:{":subject/:locale/:metric/:year":"render",":subject/:locale/:metric":"render",":subject/:locale":"render",":subject":"render","":"start"},render:function(a,b,c,d){app.config.setState(a,b,c,d)},start:function(){app.config.navigate({trigger:!0})}})}(),app.Models=app.Models||{},function(){"use strict";app.MapModel=Backbone.Model.extend({initialize:function(){},validate:function(){},parse:function(a){return a}})}(),app.Collections=app.Collections||{},function(){"use strict";function a(a,b){for(var c=a.keys()||[],d=[],e=0,f=c.length,g=-1;f>e;++e)if(g=b.indexOf(c[e]),-1!==g&&(d.push(a.get(c[e])),b.splice(g,1),!b.length))return d;return d}app.ConfigCollection=Backbone.Collection.extend({init:function(a){var b,c,d,e,f=0;this.graphs=a.graphs,this.basemap=a.basemap;var a=a.schema;b=a.length,this.state={},this.config=a,this.domain={},this.domain.year=[],new app.DynamoDropdownView({el:"#year-select",prop:"year",options:this.domain.year,defaultSelection:0}),this.domain.locale=[],new app.DynamoDropdownView({el:"#locale-select",prop:"locale",options:this.domain.locale,defaultSelection:0}),this.domain.subject=[],this.schema={};for(var g={};b>f;++f)for(e=a[f].subject,this.domain.subject.push(e),e=e.split(" ").join("_").toLowerCase(),this.schema[e]=a[f].schema,c=0,d=a[f].metrics.length;d>c;++c)g[a[f].metrics[c].mapid]=a[f].metrics[c].map;this.metricLookup=g,new app.DropdownView({el:"#type-select",prop:"subject",options:this.domain.subject,defaultSelection:0}),this.domain.metric=[],new app.SidebarView,this.domain.boundary=["No Boundary","Congressional","State Senate","State House","Chicago Community Area"],new app.DropdownView({el:"#boundary-select",prop:"boundary",options:this.domain.boundary,defaultSelection:0,silent:1}),new app.GraphPaneView,new app.LegendSelector,new app.CSV,new app.Legend,app.loading=new app.LoadingIndicator,app.screenWidth=$(window).width(),app.mapView=new app.MapView({basemap:this.basemap})},setState:function(a,b,c,d){return a?(this.state.subject!==a&&this.inDomain("subject",a)&&this.update("subject",a),b&&b!==this.state.locale&&this.inDomain("locale",b)&&this.update("locale",b),c&&c!==this.state.matric&&this.inDomain("metric",c)&&this.update("metric",c),d&&d!==this.state.year&&this.inDomain("year",d)&&this.update("year",d),this.update("sublocale",""),this.navigate({trigger:!1,replace:!0}),void app.mapData.update()):(this.trigger("reset:all"),void app.mapData.update())},inDomain:function(a,b){for(var c=0,d=this.domain[a],e=d.length;e>c;++c)if(b===d[c].toLowerCase())return!0;return!1},locateLocale:function(a){var b=a||this.state.locale,c=this.hasTractFiles();return"census_tract"===b&&void 0!==c?"il_tracts_"+c[this.state.year]:"census_tract"===b?"il_tracts_2010":"county"===b?"il_counties":"municipality"===b?"il_places":"cbsa"===b?"il_cbsa":""},locateBoundary:function(a){var a=a||this.state.boundary||"";return"congressional"===a?"il_congressional":"state_senate"===a?"PA_97-6_Senate_Districts":"state_house"===a?"PA_97-6_House_Districts":"chicago_community_area"===a?"il_chicago_community_area":""},parentUniverse:function(a){var a=a||this.state.locale;return"census_tract"===a?["State of Illinois","County"]:"county"===a?["State of Illinois","CBSA"]:!1},index:function(){return this.schema[this.state.subject].indexOf(this.state.metric)},metrics:function(){var a=this.state.subject;return _.find(this.config,function(b){return b.subject.split(" ").join("_").toLowerCase()==a})},metricName:function(){return this.metricLookup[this.state.metric]},maps:function(){var a=this.metrics();return a.metrics},years:function(){var a=this.metrics(),b=this.state.metric;return _.find(a.metrics,function(a){return a.mapid===b})},setYears:function(){var a=this.years();a&&(!this.domain.year.length||this.isDifferent(this.domain.year,a.years))&&(this.domain.year=a.years,this.trigger("reset:year",_.map(a.years,function(a){return{opt:a,lower:a}})))},setLocales:function(){var a=this.metrics();(!this.domain.locale.length||this.isDifferent(this.domain.locale,a.locale))&&(this.domain.locale=a.locale,this.trigger("reset:locale",_.map(a.locale,function(a){return{opt:a,lower:a.split(" ").join("_").toLowerCase()}})))},hasTractFiles:function(){var a=this.metrics();return a.tractfiles?a.tractfiles:void 0},isDifferent:function(a,b){var c=a.length,d=b.length;if(c!==d)return!0;for(var e=0,f=c;f>e;++e)if(a[e]!==a[e])return!0;return!1},inChange:function(){this.trigger("change:change")},update:function(a,b){if(this.state[a]!==b)switch(this.state[a]=b,this.inChange(),a){case"year":this.trigger("change:year",b);break;case"subject":this.updateDomains(),this.setYears(),this.setLocales(),this.trigger("change:subject",b);break;case"locale":this.trigger("change:locale",b);break;case"sublocale":this.trigger("change:sublocale",b);break;case"boundary":this.trigger("change:boundary",b),app.mapData.getBoundary();break;case"metric":this.setYears(),this.trigger("change:metric",b)}},updateDomains:function(){var a=this.metrics(),b=0,c=a.length;for(this.domain.metric=[];c>b;++b)this.domain.metric.push(a[b].mapid)},isReady:function(a){for(var b=0,c=a.length;c>b;++b)if(!this.state[a[b]])return!1;return!0},navigate:function(a){var b=["subject","locale","metric","year"],c="";this.isReady(b)&&(c=_.map(["subject","locale","metric","year"],function(a){return app.config.state[a]}).join("/"),app.router.navigate(c,a))}});var b=Backbone.Collection.extend({initialize:function(){this.quintiles=5},onComplete:function(){app.map.closePopup(),this.trigger("change:complete")},quintileUrl:function(){var a=_.map(["subject","metric","locale","year"],function(a){return app.config.state[a]}).join("/");return["data","maps",a+".json"].join("/")},geographyUrl:function(){return["data","topojson",app.config.locateLocale()+".json"].join("/")},parentGeographyUrl:function(a){return["data","topojson",app.config.locateLocale(a)+".json"].join("/")},boundaryUrl:function(a){return["data","topojson","il_"+a+".json"].join("/")},cache:function(a,b){this.models.push({url:a,data:b})},isCached:function(a){for(var b=0,c=this.models.length;c>b;++b)if(this.models[b].url===a)return this.models[b].data;return!1},reset:function(){function a(){b.trigger("filtered:geometry",c)}var b=this,c={topo:this.isCached(this.geographyUrl()),numerical:this.isCached(this.quintileUrl())};window.setTimeout(a,25)},update:function(){function a(a,b){a||(b&&_.each(b,function(a){a.type&&"Topology"===a.type?(a=topojson.feature(a,a.objects[app.config.locateLocale()]),h(c,a),d=a):(a=i(a),h(e,a),f=a)}),app.subLocale="",j.trigger("reset",{topo:d,numerical:f}))}var b,c=this.geographyUrl(),d=this.isCached(c),e=this.quintileUrl(),f=this.isCached(e),g=queue(),h=$.proxy(this.cache,this),i=$.proxy(this.sortQuintile,this),j=this;d||g.defer(d3.json,c),f||g.defer(d3.json,e),f&&d?(b=_.debounce(a,25),g.awaitAll(b)):g.awaitAll(a)},sortQuintile:function(a){var b=a.shift();return this.addQuintile(a,this.quintiles,b.indexOf("name"),b.indexOf("id"),b.indexOf("value"))},filter:function(b,c){var d,e,f,g=this.isCached(this.geographyUrl()),h=this.isCached(this.quintileUrl()),i=0,j=[];if("cbsa"===c){for(e=_.filter(g.features,function(a){return a.properties.cbsa===b}),d=[],f=e.length;f>i;++i)d.push(e[i].id);j=a(h,d),this.trigger("filtered:geometry",{topo:{type:"FeatureCollection",features:e},numerical:this.addQuintile(j,this.quintiles,"name","id","value")})}else{for(e=b.slice(0,5),d=h.keys()||[],f=d.length;f>i;++i)d[i].slice(0,5)===e&&j.push(h.get(d[i]));this.trigger("filtered:geometry",{topo:g,numerical:this.addQuintile(j,this.quintiles,"name","id","value")})}},filterOnQuintile:function(a){for(var b,c=this.isCached(this.quintileUrl()),d=c?c.keys():[],e=0,f=d.length,g=d3.map();f>e;++e)b=c.get(d[e]),-1!==a.indexOf(b.quintile)&&g.set(d[e],b);this.trigger("filtered:quintile",{topo:this.isCached(this.geographyUrl()),numerical:g})},addQuintile:function(a,b,c,d,e){for(var f,g,h=d3.map(),i=0,j=0,k={},l=[],m=[],n=0,o=a.length;o>n;++n)"NA"===a[n][e]?m.push(a[n]):l.push(a[n]);for(l.sort(function(a,b){return a[e]<=b[e]?-1:1}),k[i]=[l[0][e]],n=0,o=l.length,g=Math.ceil(o/b);o>n;++n)f=l[n],h.set(f[d],{quintile:i,id:f[d],value:f[e],name:f[c]}),j+=1,j>g&&(j=0,k[i].push(l[n-1][e]),i+=1,k[i]=[f[e]]);for(k[i].push(l[o-1][e]),h.set("minmax",k),n=0,o=m.length;o>n;++n)f=m[n],h.set(f[d],{quintile:"na",id:f[d],value:f[e],name:f[c]});return h},getBoundary:function(){var a,b,c,d,e=app.config.state.boundary;"no_boundary"===e?this.trigger("boundary:remove"):(b=this.boundaryUrl(e),c=this.isCached(b),c?this.trigger("boundary:loaded",c):(a=this,d=$.proxy(this.cache,this),d3.json(b,function(c){c=topojson.feature(c,c.objects[app.config.locateBoundary(e)]),d(b,c),a.trigger("boundary:loaded",c)})))}}),c=Backbone.Collection.extend({close:function(){this.trigger("close")},open:function(){this.trigger("open")},clickedOn:function(a){this.tractId!==a&&(this.tractId=a,this.get())},get:function(){queue().defer(this.query,this,this.parse)},query:function(a,b){var c=_.find(a.models,a.predicate,a),d=$.proxy(b,a);c?d(c):d3.json(a.url(),function(a){d(a)})},predicate:function(a){return a.id===this.tractId},url:function(){return["data","click",app.config.state.locale,this.tractId+".json"].join("/")},parse:function(a){this.models.push(a),this.trigger("updated",a)}});app.mapData=new b,app.graphData=new c}(),app.GraphViews=app.GraphViews||{},function(){"use strict";function a(a){return"$"+a.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function b(a){return a+"%"}function c(a){return a>1e3?a.toString().replace(/\B(?=(\d{3})+(?!\d))/g,","):a}function d(d){switch(d){case"currency":return a;case"percent":return b;case"number":return c}}var e=Backbone.View.extend({destroy:function(){this.children&&_.each(this.children,function(a){a.destroy()}),this.$el.empty(),this.stopListening()}}),f=e.extend({initialize:function(){var a=this.options,b=this;this.$el=$(a.el),this.svg=d3.select(a.el).append("svg:svg").attr("width",a.width+a.margin.left+a.margin.right).attr("height",a.height+a.margin.top+a.margin.bottom).append("g").attr("class","line-chart").attr("transform","translate("+a.margin.left+","+a.margin.top+")"),this.x=d3.scale.linear().range([0,a.width]),this.y=d3.scale.linear().range([a.height,0]),this.line=d3.svg.line().x(function(a){return b.x(a.x)}).y(function(a){return b.y(a.val)}),this.path1=this.svg.append("path").attr("class","path-light"),this.path2=this.svg.append("path").attr("class","path-dark"),this.parse=d(this.options.type),a.ticks&&(this.svg.append("text").attr("y",a.height).attr("x","-1em").text("0"),this.text=[],this.text.push(this.svg.append("text").attr("y",a.height).attr("dy","1.4em").attr("class","text-start"),this.svg.append("text").attr("y",a.height).attr("dy","1.4em").attr("x",a.width),this.svg.append("text").attr("y",0).attr("dy","0.75em").attr("x","-1em")))},update:function(a,b,c){var d=c||[],e=[b[0],b[b.length-1],this.pretty(d3.max(a.concat(d),function(a){return a.val}))],f=this;if(this.x.domain([e[0],e[1]]),this.y.domain([0,e[2]]),e[2]=this.parse(e[2]),this.options.ticks&&_.each(this.text,function(a,b){a.text(e[b])}),this.options.markers){var g=this.svg.selectAll(".year-marker").data(a);g.exit().remove(),g.enter().append("circle").attr("cx",function(a){return f.x(a.x)}).attr("cy",this.options.height).attr("class","year-marker").attr("fill",function(a){return a.x===+app.year?"#9e0142":"#fefefe"}).attr("r",4),g.transition().delay(200).attr("cy",function(a){return f.y(a.val)}).attr("cx",function(a){return f.x(a.x)})}d.length?(this.path1.datum(d).transition().delay(200).attr("d",this.line),this.path2.datum(a).transition().delay(200).attr("d",this.line)):this.path2.datum(a).transition().delay(200).attr("d",this.line)},pretty:function(a){var b=Math.ceil(a);return b+5-b%5}}),g=e.extend({collection:app.graphData,id:"",initialize:function(){if(this.listenTo(this.collection,"updated",this.update),this.$el=this.options.el,this.reset(),this.init&&this.init(),this.templateUrl){var a=$.proxy(this.render,this);app.template(this.id,this.templateUrl,{},a)}},reset:function(){this.tractData&&this.update(this.tractData)},templateUrl:"",render:function(){},update:function(){}});app.GraphViews.MedianNumber=g.extend({init:function(){var a=this.options;this.$el=a.el,this.$value=this.$el.find(".num-value"),this.$median=this.$el.find(".num-median"),this.parse=d(a.type),this.$el.find(".label-value").text(a.display),this.animate=a.animate,this.animate&&(this.$value.text("0"),this.$median.text("0"),this.lastn=0,this.props={},"currency"===a.type&&(this.props.numberStep=$.animateNumber.numberStepFactories.separator(",")),a.suffix&&(this.props.numberStep=$.animateNumber.numberStepFactories.append(a.suffix)),a.prefix&&(this.props.numberStep=$.animateNumber.numberStepFactories.append(a.prefix))),this.render(this.$median,this.parse(this.options.medians[0]))},update:function(a){var b=a[this.options.mapid]?this.parse(a[this.options.mapid][0]):"n/a";this.render(this.$value,b)},render:function(a,b){this.animate?(this.props.number=b,a.prop("number",this.lastn).animateNumber(this.props),this.lastn=b):a.text(b)}}),app.GraphViews.MedianChart=g.extend({id:"median-chart",templateUrl:"templates/graphs/median-chart.html",render:function(){var a=$("#"+this.id+"-template"),b="graph-"+this.options.subject;this.$el.html(a.html()),this.$title=this.$el.find(".graph-title"),this.$graph=this.$el.find(".graph-body"),this.$graph.attr("id",b),this.children=[],this.children.push(new f({el:"#"+b,width:this.$graph.width()-80,height:120,margin:{left:75,right:5,top:5,bottom:25},type:this.options.type,ticks:!0,markers:!0})),this.options.tractName||this.$title.text(this.options.display),this.options.tractData&&this.update(this.options.tractData)},update:function(a){this.tractData=a;var b=this.options.years,c=_.map(a[this.options.mapid],function(a,c){return{val:a,x:b[c]}}),d=_.map(this.options.medians,function(a,c){return{val:a,x:b[c]}});this.children[0].update(c,b,d),this.options.tractName&&this.updateTitle(a.name)},updateTitle:function(a){this.$title.text("census_tract"===app.config.state.locale?"Tract "+a+this.options.display:a+this.options.display)}})}(),app.Views=app.Views||{},function(){"use strict";function a(a){return"$"+a.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function b(a){return a+"%"}function c(a){return a>1e3?a.toString().replace(/\B(?=(\d{3})+(?!\d))/g,","):a}function d(){switch(app.config.years().type){case"currency":return a;case"percent":return b;case"number":return c}}function e(a,b){var c,d,e,f,g,h,i,j,k=!1,l=a[0],m=a[1];for(d=0,e=b.length;e>d;++d){c=b[d].geometry.coordinates[0];for(var n=0,o=c.length-1;n<c.length;o=n++)f=c[n][0],g=c[n][1],h=c[o][0],i=c[o][1],j=g>m!=i>m&&(h-f)*(m-g)/(i-g)+f>l,j&&(k=!k);if(k)return b[d].properties}return!1}var f=navigator.userAgent.toLowerCase().indexOf("firefox")>-1,g={};app.GraphPaneView=Backbone.View.extend({el:"#graph-pane",collection:app.graphData,events:{"click #close-graph-pane":"close"},initialize:function(){this.listenTo(this.collection,"open",this.open),this.listenTo(this.collection,"close",this.close),this.listenTo(this.collection,"updated",this.update),this.listenTo(app.mapData,"change:complete",this.reset),this.$title=this.$("#graph-title"),this.title=" Vacancy",this.$content=this.$("#graph-content"),this.$legend=$(".info .legend"),this.view="",this.render()},render:function(){var a=this,b=app.config.graphs;_.each([b[0],b[1]],function(b,c){new app.GraphViews.MedianChart(_.extend({el:a.$content.find("#median-graph-"+(c+1)),tractName:c-1},b))}),_.each([b[2],b[3]],function(a,b){new app.GraphViews.MedianNumber(_.extend({el:$("#numeric-"+(b+1)),animate:!1},a))})},reset:function(){this.close()},update:function(a){this.updateTitle(a.name)},updateTitle:function(a){this.$title.text("census_tract"===app.config.state.locale?"Tract "+a+this.title:a+this.title)},isOpen:!1,open:function(){this.isOpen||this.slideUp(),$("#open-graph").hide(),$("#close-graph").show()},close:function(){this.isOpen&&this.slideDown(),$("#close-graph").hide(),$("#open-graph").show()},slideUp:function(){this.$el.addClass("slide-up"),this.$legend.hide(),this.isOpen=!0},slideDown:function(){this.$el.removeClass("slide-up"),this.$legend.show(),this.isOpen=!1},views:{NumberCompare:["employment","income","jobs"],MedianChart:["housing","mortgage"]},translate:function(a){switch(a){case"income":case"employment":case"jobs":return"NumberCompare";case"mortgage":case"housing":return"MedianChart"}},rerender:function(){var a=app.config.state.subject,b=app.config.state.metric,c=this.tractData?this.tractData.name:"Tract";if(this.isTract="census_tract"===app.config.state.locale?1:0,this.subject!==a||this.metric!==b){switch(this.view&&-1!==this.views[this.view].indexOf(a)?this.child.reset():(this.view=this.translate(a),this.child&&this.child.destroy(),this.child=new app.GraphViews[this.view]({el:this.$content,tractData:this.tractData})),this.metric=b,this.subject=a,a){case"mortgage":case"housing":this.title=" "+app.human_metrics[app.config.state.metric];break;case"income":case"employment":case"jobs":this.title=" "+a.charAt(0).toUpperCase()+a.slice(1);break;default:this.title=" Metrics"}this.updateTitle(c)}}}),app.LegendSelector=Backbone.View.extend({el:"#quintile-wrap",collection:app.mapData,events:{"click .quintile-legend":"filter","click #clear-quintile":"clear"},initialize:function(){this.$clear=this.$("#clear-quintile"),this.listenTo(this.collection,"reset",this.hideClear),this.listenTo(this.collection,"filtered:geometry",this.hideClear)},selections:[],filter:function(a){console.log("in filter"),a.preventDefault();var b=$(a.currentTarget),c=b.text(),d=this.selections.indexOf(c),e="";return b.hasClass("selected")&&-1!==d?(this.selections.splice(d,1),b.removeClass("selected")):(this.selections.push(c),b.addClass("selected")),this.selections.length?this.clearShowing||(this.$clear.show(),this.clearShowing=!0):(this.hideClear(),this.reset()),this.$clear.show(),this.selections.length&&(_.each(this.selections,function(a){a=""+(parseInt(a,10)-1),e+=a}),app.config.inChange(),app.mapData.filterOnQuintile(e),app.config.state.sublocale=""),!1},clearShowing:!1,hideClear:function(){this.$(".selected").removeClass("selected"),this.clearShowing=!1,this.$clear.hide(),this.selections=[]},clear:function(a){return a.preventDefault(),this.hideClear(),this.reset(),!1},reset:function(){app.config.inChange(),this.collection.update()}}),app.DropdownView=Backbone.View.extend({events:{change:"change"},initialize:function(){this.init()},init:function(){this.listenTo(app.config,"reset:all",this.reset),this.listenTo(app.config,"change:"+this.options.prop,this.sync),this.prop=this.options.prop,this.$elm=$(this.options.el),this.choices=_.map(this.options.options,function(a){return{opt:a,lower:a.split(" ").join("_").toLowerCase()}}),this.render(),this.toSelect=this.options.defaultSelection,-1!==this.toSelect&&this.select(this.toSelect),this.update()},sync:function(a){if(this.$selected.attr("value")!==a)for(var b=0,c=this.choices.length;c>b;++b)if(this.choices[b].lower===a)return void this.select(b)},reset:function(){this.select(-1===this.toSelect?0:this.toSelect)},change:function(){this.$selected=this.$elm.find("option:selected"),this.update(),this.silent||app.config.navigate({trigger:!0})},select:function(a){var b=this.$elm.find("option").eq(a);"selected"!==b.attr("selected")&&(b.attr("selected","selected"),this.$selected=b)},update:function(){app.config.update(this.prop,this.$selected.attr("value"))},render:function(){var a=this.template,b=_.map(this.choices,function(b){return"Cbsa"===b.opt&&(b.opt=b.opt.toUpperCase()),a(b)});b&&this.$elm.html(b.join())},template:_.template('<option value="<%= lower %>"><%= opt %></option>')}),app.DynamoDropdownView=app.DropdownView.extend({initialize:function(){this.listenTo(app.config,"reset:"+this.options.prop,this.reflow),this.init()},reflow:function(a){this.choices=_.map(a,function(a){return{opt:a.opt,lower:a.lower}}),this.render(),this.toSelect=this.toSelect>a.length-1?0:this.toSelect,this.select(this.toSelect),this.update()}}),app.ParentSelector=Backbone.View.extend({el:"#universe",events:{change:"select"},template:_.template('<option value="<%= val %>"><%= text %></option>'),initialize:function(){var a=$.proxy(this.kill,this);app.map.once("popupclose",a),this.render()},render:function(){var a=this.template;this.$el.html(_.map(this.options.selects,function(b){return a({text:b,val:b.toLowerCase().split(" ").join("_")})}).join("")),app.config.state.sublocale&&this.$("option").each(function(){g=$(this),g.attr("value")==app.config.state.sublocale&&g.attr("selected",!0)})},select:function(){var a=this.$("option:selected").attr("value");"state_of_illinois"===a?(app.config.update("sublocale",""),app.mapData.reset()):(app.config.update("sublocale",a),app.mapData.filter(this.options.tractId,a))},kill:function(){this.unbind(),this.remove()}}),app.SidebarView=Backbone.View.extend({el:"#map-switch",events:{"click a":"toggle"},template:_.template("<li><a href='#' data-value='<%= mapid %>' class='button radius'><%= map %></a></li>"),target:{},initialize:function(){this.listenTo(app.config,"change:subject",this.render),this.$list=this.$("ul"),this.render()},render:function(){var a=_.map(app.config.maps(),this.renderOne,this);this.clear(),this.animateIn(a),this.target=this.$("li").eq(0).find("a"),this.target.addClass("active"),this.update()},renderOne:function(a){return $(this.template(a))},animateIn:function(a){for(var b=0,c=a.length;c>b;++b)this.$list.append(a[b]),a[b].fadeIn(200)},clear:function(){this.$list.find("li").remove()},toggle:function(a){return a.preventDefault(),this.newTarget=$(a.currentTarget),this.newTarget.hasClass("active")||(this.target.removeClass("active"),this.target=this.newTarget,this.target.addClass("active"),this.update(),app.config.navigate({trigger:!0})),!1},update:function(){app.config.update("metric",this.target.attr("data-value"))}}),app.MapView=Backbone.View.extend({el:"#map",collection:app.mapData,events:{"click #open-graph":"openGraph","click #close-graph":"closeGraph"},initialize:function(){app.map=app.map||L.mapbox.map("map",this.options.basemap).setView([41.671,-88.899],8),app.screenWidth<641&&(app.map.scrollWheelZoom.disable(),app.map.setZoom(5)),app.map.addControl(L.mapbox.geocoderControl(this.options.basemap)),app.map.whenReady(this.declare,this),app.geocoder=$(".leaflet-control-mapbox-geocoder-toggle.mapbox-icon.mapbox-icon-geocoder"),app.geocoder.attr("id","geocoder"),this.listenTo(this.collection,"reset",this.render),this.listenTo(this.collection,"filtered:quintile",this.update),this.listenTo(this.collection,"filtered:geometry",this.update),this.listenTo(this.collection,"boundary:loaded",this.addBoundary),this.listenTo(this.collection,"boundary:remove",this.clearBoundary),this.spinner=new Spinner({color:"#888",length:2,speed:.8}).spin(document.getElementById("loader"))},openGraph:function(){app.graphData.open()},closeGraph:function(){app.graphData.close()},isReady:!1,needsRender:!1,projection:function(a){var b=app.map.latLngToLayerPoint(new L.LatLng(a[1],a[0]));return[b.x,b.y]},declare:function(){this.isReady=!0;var a=this.container=d3.select(app.map.getPanes().overlayPane);this.path=d3.geo.path().projection(this.projection),this.drag=d3.behavior.drag(),this.pop=L.popup({closeOnClick:!1,autoPan:!1});var b,c=$.proxy(this.reset,this),d=!1,e=!0,g=!1;if(app.map.on("viewreset",function(){g||(g=!0,b=setInterval(function(){e&&(clearInterval(b),g=!1,c())},10))}),app.map.on("zoomstart",function(){this.closePopup(),d=!0,e=!1,a.style("display","none")}),app.map.on("zoomend",function(){d=!1,window.setTimeout(function(){d||(e=!0)},125)}),f){this.$pane=$(".leaflet-map-pane").eq(0),this.transform=[0,0];var h=$.proxy(this.getTransform,this);app.map.on("moveend",h)}this.needsRender&&this.render(this.data)},getTransform:function(){var a=this.$pane.css("transform");a=a.slice(a.indexOf("(")+1,a.indexOf(")")).split(", "),this.transform=[parseInt(a[4],10),parseInt(a[5],10)]},reset:function(){if(this.features){var a=d3.geo.bounds(this.features),b=this.projection(a[0]),c=this.projection(a[1]);this.svg.attr("width",c[0]-b[0]).attr("height",b[1]-c[1]).style("margin-left",b[0]+"px").style("margin-top",c[1]+"px"),this.g.attr("transform","translate("+-b[0]+","+-c[1]+")"),this.paths.attr("d",this.path),this.boundary&&this.boundary.attr("d",this.path),this.container.style("display","block"),this.collection.onComplete()}},wipe:function(){this.boundary=!1,this.container.select("svg").remove(),this.svg=this.container.append("svg:svg");var a=this.isFaded?" faded-paths":"";this.g=this.svg.append("svg:g").attr("class","leaflet-zoom-hide"+a).call(this.drag)},render:function(a){return this.data=a,this.isReady?(this.features=a.topo,this.wipe(),void this.draw(a,!1)):void(this.needsRender=!0)},update:function(a){this.wipe(),this.draw(a,!0)},draw:function(a){for(var b,c=a.numerical,g=this.pop,h=[],i=d(),j=this,k={},l=!1,m=!1,n=this.features.features,o=n.length,p=[],q=0;o>q;++q)k=c.get(n[q].id),k&&p.push(n[q]);this.paths=this.g.selectAll(".path").data(p).enter().append("path").attr("class",function(a){return"path quintile-"+c.get(a.id).quintile}).on("click",function(a){return d3.event.defaultPrevented||!c.get(a.id)?!1:b?(clearTimeout(b),b=null,!1):(f?(h=d3.mouse(this),h=app.map.layerPointToLatLng([h[0]-j.transform[0],h[1]-j.transform[1]])):h=app.map.layerPointToLatLng(d3.mouse(this)),l=j.boundaryData?e([h.lng,h.lat],j.boundaryData):!1,m=a.properties.cbsa&&"99"===a.properties.cbsa?!1:app.config.parentUniverse(),void(b=setTimeout(function(){b=null,k=c.get(a.id),g.setLatLng(h),g.setContent("na"==k.quintile?"<h3>"+(k.name||"Tract "+k.id)+"</h3><p>Data not available</p>":j.template({name:k.name||"Tract "+k.id,value:i(k.value),plus_quintile:k.quintile+1,metric:app.config.metricName(),boundary:l,selects:m})),g.openOn(app.map),m&&(m={selects:m,selected:k.quintile},m.tractId="county"===app.config.state.locale?a.properties.cbsa:k.id,app.parents=new app.ParentSelector(m)),app.map.setView([h.lat,h.lng]),app.graphData.clickedOn(k.id)},200)))}).on("mouseover",function(){d3.select(this).style("cursor","pointer")}).on("mouseout",function(){d3.select(this).style("cursor","default")}),this.reset(),"no_boundary"!==app.config.state.boundary&&this.collection.getBoundary()},zoomToBounds:function(a){var b=d3.geo.bounds({type:"FeatureCollection",features:a});app.map.fitBounds([[b[0][1],b[0][0]],[b[1][1],b[1][0]]])},addBoundary:function(a){this.boundary&&this.removeBoundary();var b=this.g.insert("g",":first-child").attr("class","boundary-container");this.boundary=b.selectAll(".boundary").data(a.features).enter().append("path").attr("class","boundary").attr("d",this.path),this.boundaryData=a.features,this.fadePaths(),this.collection.onComplete()},clearBoundary:function(){this.removeBoundary(),this.unFadePaths(),this.collection.onComplete()},removeBoundary:function(){this.g.select(".boundary-container").remove(),this.boundary=!1,this.boundaryData=!1},fadePaths:function(){this.isFaded||(this.g.attr("class","leaflet-zoom-hide faded-paths"),this.isFaded=!0)},unFadePaths:function(){this.g.attr("class","leaflet-zoom-hide"),this.isFaded=!1},template:_.template($("#popup-template").html())}),app.LoadingIndicator=Backbone.View.extend({initialize:function(){this.listenToOnce(app.mapData,"reset",this.activate)},activate:function(){this.listenTo(app.config,"change:change",this.show),this.listenTo(app.mapData,"change:complete",this.hide),app.map.on("zoomstart",this.show),app.map.on("zoomend",this.hide)},show:function(){$("#loader").show()},hide:function(){$("#loader").hide()}}),app.CSV=Backbone.View.extend({el:"#csv-container",template:_.template($("#csv-download-template").html()),events:{"click .csv-download":"download"},initialize:function(){var a=$.proxy(this.render,this);$("#csv-open").click(a)},render:function(){var a,b=this.template,c=app.config.state.subject,d=app.config.state.locale,e=app.config.state.metric,f="",a=_.map(app.config.domain.year,function(a){return f=[d,e,a+".csv"].join("_"),b({filename:f,locale:d,subject:c,metric:e,year:a})});this.$el.html(a.join(""))},download:function(a){var b=$(a.currentTarget),c=b.attr("data-metric"),d=b.attr("data-year"),e=b.attr("data-locale"),f=["data/maps",b.attr("data-subject"),c,e,d+".json"].join("/"),g=this;d3.json(f,function(a){g.toCSV(a,c,d,e)})},toCSV:function(a,b,c,d){for(var e=[],f=3===a[0].length?"tract,tract-name,":"tract,",g=[d,b,c+".csv"].join("_"),h=1,i=a.length;i>h;e.push(a[h].join(",")),++h);var j=c+" "+f+b+"\n"+e.join("\n"),k=new Blob([j],{type:"text/csv:charset=utf-8;"});if(navigator.msSaveBlob)navigator.msSaveBlob(k,g);else{var l=document.createElement("a");if(void 0!==l.download){var m=URL.createObjectURL(k);l.setAttribute("href",m),l.setAttribute("download",g),l.style="visibility:hidden",l.setAttribute("target","_blank"),document.body.appendChild(l),l.click(),document.body.removeChild(l)}else window.open(encodeURI("data:text/csv;charset=utf-8,",+j))}}}),app.Legend=Backbone.View.extend({template:_.template($("#quintile-legend-template").html()),el:"#quintile-legend",collection:app.mapData,initialize:function(){this.listenTo(this.collection,"reset",this.render),this.listenTo(this.collection,"filtered:geometry",this.render)},render:function(a){var b=d(),c=_.map(a.numerical.get("minmax"),function(a){var c=_.map(a,function(a){return d3.round(a,2)});return b(c[0])+" - "+b(c[1])});this.$el.html(this.template({values:c}))}})}();